<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' http://127.0.0.1:8765; img-src 'self' data: blob:;">
    <title>Margo - AI PDF Reader</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="node_modules/katex/dist/katex.min.css">
</head>
<body>
    <div id="app">
        <!-- Top Toolbar -->
        <header id="toolbar">
            <div class="toolbar-left">
                <button id="btn-open" class="toolbar-btn" title="Open PDF (Ctrl+O)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                    </svg>
                    <span>Open</span>
                </button>
                <div class="separator"></div>
                <span id="file-name" class="file-name">No file opened</span>
            </div>
            <div class="toolbar-center">
                <button id="btn-prev" class="toolbar-btn" title="Previous Page">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6"/>
                    </svg>
                </button>
                <span id="page-info" class="page-info">Page 0 / 0</span>
                <button id="btn-next" class="toolbar-btn" title="Next Page">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </button>
                <div class="separator"></div>
                <button id="btn-zoom-out" class="toolbar-btn" title="Zoom Out (-)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35M8 11h6"/>
                    </svg>
                </button>
                <span id="zoom-level" class="zoom-level">100%</span>
                <button id="btn-zoom-in" class="toolbar-btn" title="Zoom In (+)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35M11 8v6M8 11h6"/>
                    </svg>
                </button>
                <button id="btn-fit" class="toolbar-btn" title="Fit to Width">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M9 3v18M15 3v18"/>
                    </svg>
                </button>
                <button id="btn-reset-zoom" class="toolbar-btn" title="Reset Zoom (100%)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="9"/>
                        <path d="M12 8v4l2 2"/>
                    </svg>
                    <span>100%</span>
                </button>
            </div>
            <div class="toolbar-right">
                <div class="model-selector">
                    <label for="provider-select">AI:</label>
                    <select id="provider-select" class="toolbar-select" title="Select AI Provider">
                        <option value="">Loading...</option>
                    </select>
                    <select id="model-select" class="toolbar-select" title="Select Model">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="separator"></div>
                <button id="btn-screenshot" class="toolbar-btn toggle-btn" title="Q&A Mode (Ctrl+Q)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9 9a3 3 0 115.83 1c0 2-3 3-3 3M12 17h.01"/>
                    </svg>
                    <span>Q&A</span>
                </button>
                <button id="btn-note-mode" class="toolbar-btn toggle-btn" title="Note Mode (Ctrl+N)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                    </svg>
                    <span>Note</span>
                </button>
                <div class="separator"></div>
                <div id="connection-status" class="connection-status disconnected" title="Backend connection status">
                    <span class="status-dot"></span>
                    <span class="status-text">Disconnected</span>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content">
            <!-- PDF Viewer -->
            <div id="pdf-container">
                <div id="pdf-viewer">
                    <div id="welcome-message">
                        <h1>Welcome to Margo</h1>
                        <p>AI-powered PDF reader for academic papers</p>
                        <button id="btn-open-welcome" class="primary-btn">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                            </svg>
                            Open a PDF
                        </button>
                        <p class="hint">Or press Ctrl+O</p>
                    </div>
                    <div id="pages-container"></div>
                </div>
            </div>

            <!-- Notes Sidebar (Left) -->
            <aside id="notes-sidebar" class="left-sidebar">
                <div id="notes-sidebar-header" class="sidebar-header">
                    <button id="btn-toggle-notes-sidebar" class="icon-btn" title="Toggle Notes">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </button>
                    <h2>Notes</h2>
                </div>
                <div id="notes-list">
                    <div id="no-notes" class="empty-state">
                        <p>No notes yet</p>
                        <p class="hint">Press Ctrl+N or click Note, then select text</p>
                    </div>
                </div>
            </aside>

            <!-- Annotations Sidebar -->
            <aside id="sidebar">
                <div id="sidebar-header">
                    <h2>Annotations</h2>
                    <button id="btn-toggle-sidebar" class="icon-btn" title="Toggle Sidebar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                    </button>
                </div>
                <div id="annotations-list">
                    <div id="no-annotations" class="empty-state">
                        <p>No annotations yet</p>
                        <p class="hint">Select an area with Q&A mode (Ctrl+Q) and ask a question</p>
                    </div>
                </div>
            </aside>
        </main>

        <!-- Chat Panel (appears when an annotation is selected) -->
        <div id="chat-panel" class="hidden">
            <div id="chat-header">
                <div class="chat-header-left">
                    <button id="btn-close-chat" class="icon-btn" title="Close Chat">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <span id="chat-title">Annotation Chat</span>
                </div>
                <button id="btn-delete-annotation" class="icon-btn danger" title="Delete Annotation">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                    </svg>
                </button>
            </div>
            <div id="chat-preview">
                <img id="chat-preview-image" src="" alt="Selected area">
                <p id="chat-preview-text"></p>
            </div>
            <div id="chat-messages"></div>
            <div id="chat-input-container">
                <textarea id="chat-input" placeholder="Ask a question about this section..." rows="2"></textarea>
                <button id="btn-send" class="primary-btn" title="Send (Enter)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Note Panel (appears when a note is selected) -->
        <div id="note-panel" class="hidden">
            <div id="note-header">
                <div class="note-header-left">
                    <button id="btn-close-note" class="icon-btn" title="Close Note">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12H19M12 5l7 7-7 7"/>
                        </svg>
                    </button>
                    <span id="note-title">Note</span>
                </div>
                <div class="note-header-right">
                    <button id="btn-note-text" class="icon-btn active" title="Text Mode">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 7V4h16v3M9 20h6M12 4v16"/>
                        </svg>
                    </button>
                    <button id="btn-note-draw" class="icon-btn" title="Drawing Mode">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 19l7-7 3 3-7 7-3-3zM18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5zM2 2l7.586 7.586"/>
                        </svg>
                    </button>
                    <button id="btn-delete-note" class="icon-btn danger" title="Delete Note">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="note-selected-text">
                <p id="note-selected-text-content"></p>
            </div>
            <div id="note-content-container">
                <!-- Text mode -->
                <textarea id="note-text-input" placeholder="Add your note here..."></textarea>
                <!-- Drawing mode -->
                <div id="note-drawing-container" class="hidden">
                    <canvas id="note-drawing-canvas"></canvas>
                    <div id="note-drawing-controls">
                        <button id="btn-clear-drawing" class="secondary-btn">Clear</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Selection overlay for screenshot mode -->
        <div id="selection-overlay" class="hidden">
            <div id="selection-box"></div>
        </div>

        <!-- Floating annotation previews (auto-opened on scroll) -->
        <div id="floating-annotations-container"></div>
        
        <!-- SVG layer for annotation arrows -->
        <svg id="annotation-arrows" class="annotation-arrows-svg"></svg>

        <!-- Floating note previews (auto-opened on scroll) -->
        <div id="floating-notes-container"></div>
        
        <!-- SVG layer for note arrows -->
        <svg id="note-arrows" class="note-arrows-svg"></svg>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="hidden">
            <div class="loader"></div>
            <p id="loading-text">Loading...</p>
        </div>
    </div>

    <script src="node_modules/katex/dist/katex.min.js"></script>
    <script src="node_modules/marked/marked.min.js"></script>
    <script src="renderer.js" type="module"></script>
</body>
</html>
